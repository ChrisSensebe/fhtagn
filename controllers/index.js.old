var express          = require('express');
var router           = express.Router();
var siteControllers  = require('./siteControllers.js.old');
var adminControllers = require('./adminControllers.js');
var User             = require('../models/user.js');
var Post             = require('../models/post.js');
var passport         = require('passport');
var isLogged         = require('../middlewares/isLogged.js');

var multer = require('multer');
var upload = multer({
    dest : '../public/images',
    limits : {
        fileSize : 1000000,
        files    : 1
    }
});

/**
 * site controllers
 */

router.get('/post/:id', siteControllers.getPostById);
router.get('/tags',     siteControllers.getTags);
router.get('/archives', siteControllers.getArchives);
router.get('/about',    siteControllers.getAbout);
router.get('/login',    siteControllers.getLogin);
router.post('/login',   passport.authenticate('local-login', {
    successRedirect : '/admin/',
    failureRedirect : '/login',
    failureFlash    : true
}));

/**
 * admin controllers
 * protected controllers user must be logged
 */

router.all('/admin/*',             isLogged);
router.get('/admin/',              adminControllers.getAdminHome);
router.get('/admin/newPost',       adminControllers.getNewPost);
router.get('/admin/post/:id',      adminControllers.getEditPostById);
router.get('/admin/users',         adminControllers.getUsers);
router.get('/admin/newUser',       adminControllers.getNewUser);
router.get('/admin/user/:id',      adminControllers.getUserById);
router.get('/admin/files',         adminControllers.getFiles);
router.get('/admin/siteSettings',  adminControllers.getSettings);
router.get('/admin/logout',        adminControllers.getLogout);
router.post('/admin/saveNewPost',  adminControllers.postNewPost);
router.post('/admin/savePost',     adminControllers.postSavePost);
router.post('/admin/delPost',      adminControllers.postDelPost);
router.post('/admin/saveNewUser',  adminControllers.postSaveNewUser);
router.post('/admin/saveUser',     adminControllers.postSaveUser);
router.post('/admin/delUser',      adminControllers.postDelUser);
router.post('/admin/upload', upload.single('image'), adminControllers.postUpload);
router.post('/admin/delFile',      adminControllers.postDelFile);
router.post('/admin/siteSettings', adminControllers.postSaveSettings);

module.exports = router;