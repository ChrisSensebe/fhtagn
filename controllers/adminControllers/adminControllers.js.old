var Post        = require('../../models/post.js');
var User        = require('../../models/user.js');
var adminLayout = require('../../config/adminLayout.js');
var adminPages  = require('../../config/adminPages.js');

// find all post in database, render admin homepage

// set goodbye flash message, log user out, redirect to site homepage

// render create newpost page

// save new post in database

// get post by id in database, render edit post page

// save post in database

// find and delete post from database

// find users in database, render users page

// render new user page

// get user in database, render user page
exports.getUserById = function(req, res, next){
    // get user id from url
    var userId = req.params.id;
    // page content
    var pageContent = {
        adminLayout : adminLayout,
        page : adminPages.userPage
    }
    // find user in database, render edit user page
    User.findOne({_id : userId}, function(err, doc){
        if(err){
            return next(err);
        }
        // add user to page content, render page
        pageContent.page.user = doc;
        res.render('adminViews/user', pageContent);
    });
};
// save new user in database, redirect to users page
exports.postSaveNewUser = function(req, res, next){
    // get user info from form
    var username = req.body.username;
    var email    = req.body.email;
    var password = req.body.password;
    var role     = req.body.role;
    // create new user
    var newUser = new User({
        username     : username,
        email        : email,
        passwordHash : password,
        role         : role,
        created      : Date.now(),
        updated      : Date.now()
    });
    // save user in database, set flash messages, redirect to users
    newUser.save(function(err){
        if(err){
            req.flash('danger', 'Error saving user in database');
            return next(err);
        }
    });
    // all went well redirect to users
    req.flash('success', 'User successfully saved');
    res.redirect('/admin/users');
};
// find user in database, update user, redirect to users page
exports.postSaveUser = function(req, res, next){
    // get user info from form
    var id       = req.body.id;
    var username = req.body.username;
    var email    = req.body.email;
    if(req.body.password){
        var password = req.body.password;
    }
    var role = req.body.role;
    // find user in database
    User.findOne({_id : id}, function(err, doc){
        if(err){
            return next(err);
        }
        // update user
        doc.username = username;
        doc.email    = email;
        if(password){
            doc.passwordHash = password;
        }
        doc.role = role;
        doc.updated  = Date.now();
        // save user in database
        doc.save(function(err){
            if(err){
                req.flash('danger', 'Error saving user in database');
                return next(err);
            }
        });
        req.flash('success', 'User successfully saved');
        res.redirect('/admin/users');
    });
};
// del user from database, redirect to users
exports.postDelUser = function(req, res, next){
    // get user id
    var userId = req.body.delUser;
    // delete user from database
    User.remove({_id : userId}, function(err){
        if(err){
            req.flash('danger', 'Error deleting user from database');
            return next(err);
        }
        req.flash('success', 'User succesfully deleted');
        res.redirect('/admin/users');
    });
};
// render files page
exports.getFiles = function(req, res){
    res.render('adminViews/files', {
        adminLayout : adminLayout,
        page : adminPages.filesPage
    });
};
// upload file, redirect to files
exports.postUpload = function(req, res){
    req.flash('success', 'File successfully saved');
    res.redirect('/admin/files');
};
// delete file, redirect to files
exports.postDelFile = function(req, res){
    res.redirect('/admin/files');
};
// render theme page
exports.getSettings = function(req, res){
    res.render('adminViews/settings', {
        adminLayout : adminLayout,
        page : adminPages.themePage
    });
};
// save theme in db, redirect to them
exports.postSaveSettings = function(req, res){
    res.redirect('/admin/siteSettings');
};